---
volumes:
  readeck-data:
  minio-data:

services:
  app:
    image: codeberg.org/readeck/readeck:0.21.3
    container_name: readeck
    ports:
      - 8000:8000
    volumes:
      - readeck-data:/readeck
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/bin/readeck", "healthcheck", "-config", "config.toml"]
      interval: 30s
      timeout: 2s
      retries: 3


  sqlite-backup:
    build:
      context: .
      dockerfile: Dockerfile
    image: le-lenn/sqlite-to-s3:local
    # Mount the same volume as the app
    volumes:
      - readeck-data:/readeck
    environment:
      # Absolute path inside the shared volume where the app stores the DB
      DATABASE_PATH: /readeck/data/db.sqlite3
      BACKUP_PATH: /tmp/db.sqlite3.bak
      SCHEDULE: "* * * * *"
      S3_BUCKET: readeck-backups
      S3_PREFIX: backups/sqlite/
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      # Optional: if using an S3-compatible provider (MinIO, Cloudflare R2, Wasabi)
      S3_ENDPOINT: http://minio:9000
      AWS_DEFAULT_REGION: us-west-2
      AGE_PASSPHRASE: test-passphrase
      # Optional: tune backup/restore busy timeout (ms), default 10000
      # SQLITE_TIMEOUT_MS: 10000
      # Optional: notify another service when a backup completes
      POST_WEBHOOK_URL: ${POST_WEBHOOK_URL}
    restart: unless-stopped
    depends_on:
      - minio

  minio:
      command: 'server /data --console-address ":9001"'
      image: minio/minio
      ports:
          - '9001:9001'
          - '9000:9000'
      environment:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
      volumes:
          - minio-data:/data
      healthcheck:
        test: ["CMD", "curl", "-fsS", "http://127.0.0.1:9000/minio/health/ready"]
        interval: 10s
        timeout: 2s
        retries: 6
      restart: unless-stopped

  minio-bucket-creater:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: ["sh", "-c"]
    command: ["mc alias set minio http://minio:9000 minioadmin minioadmin && until mc ls minio >/dev/null 2>&1; do echo waiting for minio; sleep 1; done && mc mb minio/readeck-backups"]
    restart: "no"
